use verification_lib::{AttestationReport, SevVerificationResult, SevVerifier};
use zerocopy::FromBytes;

const MILAN_ATTESTATION: &str = "03000000020000001f000300000000000100000000000000000000000000000002000000000000000000000000000000000000000100000004000000000018db25000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005feee30d6d7e1a29f403d70a4198237ddfb13051a2d6976439487c609388ed7f98189887920ab2fa0096903a0c23fca14f4448c67f3c8dfc8de8a5e37125d807dadcc41f06cf23f615dbd52eec777d100ad79ceb0b648b0e6a90d8aa9f6ea24c33a968b6632085353145e8b19a4741a2dab9ba342e13be4fc0d225e889cc1a580000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e01036273418d910bdca3f5cb9c7d849e88e2141483eb6cc9afd794ffbbbcbcffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff04000000000018db1901010000000000000000000000000000000000000000004ffb5cb4fd594f3fee6528fc3fb10370bb38abe89dcd5ba2cf0ab6a11df2ca282add516bef45a890a8c9f9732bdca68f9f3f16c42e846030a800295dbeb19ba504000000000018db1d3701001d37010004000000000018db000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c4c97ce68cfa7fe769a569fc55cee5ad38b238a4e1db928436a006b76e9a5885851d13c88892e5ffd93f3e1cf853f3b70000000000000000000000000000000000000000000000001e739e881fffadfeab34e3fb205ff0a5d8992496d0fb390a18baa725de048253e664e519b8f38309061b4af2a3e69f530000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
const GENOA_ATTESTATION: &str = "03000000020000001f00030000000000010000000000000000000000000000000200000000000000000000000000000000000000010000000a0000000000175427000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005feee30d6d7e1a29f403d70a4198237ddfb13051a2d6976439487c609388ed7f98189887920ab2fa0096903a0c23fca14f4448c67f3c8dfc8de8a5e37125d807dadcc41f06cf23f615dbd52eec777d100ad79ceb0b648b0e6a90d8aa9f6ea24c33a968b6632085353145e8b19a4741a2dab9ba342e13be4fc0d225e889cc1a58000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c840e4fc01bec5121388abbf2e850c5b1d482adab7a4b06c4d93028c56599429ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0a00000000001754191101000000000000000000000000000000000000000000b1e24a27bbc3a4d58090d8b89851dce3b8031544be249b9ac17132bb222b027622347ee4d0fe4f689efdfc47a68cefc686cbb448d01436506ee1e28010cab7c00a0000000000175428370100283701000a0000000000175400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000064e80f5b0f231b2d5e5c36ad8d347507b1faad4a28982bfea12dd6a1d36e05b4e28f4fd86fc2cf93379418327a2c4c42000000000000000000000000000000000000000000000000c81a42207120f35ecf3ac1b64673b080b4c27b6b3d471c17aea8d9b5cfd7f56138df672d51a141a739da89c28787c7290000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
const TURIN_ATTESTATION: &str = "05000000020000001f0003000000000001000000000000000000000000000000020000000000000000000000000000000000000001000000010101040000005165000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006d6c354511d6f7c6d7504668903dc5bdc066a048b651840d8d03fb85299ebfa142fccf1d1b0baca496841bdf243619d4b3452a0ed30f1010bd32740dd1610bc63296ceb0f882f2cac3a3152d651fe7e44068e9ae4b315aa4b33938ce0ed01a3d5d8e80eb98eab479a0558cd7de9d4d40d6d80d328d90732688a42b13a0cd6405000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d2f0b13e226f7c8aee44f2fd22cac739438124864fec3e3a2249901a2f4bc9a6ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff01010104000000511a020100000000000000000000000000000000000000000059790fb1c39f35c100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101010400000051413701004137010001010104000000513f000000000000003f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000029d46ab22f4f295fe22a63fce3fb15120afa350b1842e0daf19225627aa817f31a6f375d1de6f150d67c7e5e209f0ef6000000000000000000000000000000000000000000000000223f8e2870adce4d54c64a04dbea5109f3e5bc143e8498c1d07fbcb6ef2006a5be92782fed9d59291971f89b06c5cc900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

pub async fn verify_attestation_hex(hex_input: &str) -> Result<SevVerificationResult, String> {
    let bytes = hex::decode(hex_input).map_err(|e| format!("Failed to decode hex: {e}"))?;
    let attestation_report = AttestationReport::read_from_bytes(&bytes)
        .map_err(|e| format!("Failed to parse attestation report from bytes: {:?}", e))?;

    let mut verifier = SevVerifier::new()
        .await
        .map_err(|e| format!("Failed to initialize verifier: {e}"))?;

    verifier
        .verify_attestation(&attestation_report)
        .await
        .map_err(|e| format!("Verification call failed: {e}"))
}

pub async fn verify_milan_attestation() -> Result<SevVerificationResult, String> {
    verify_attestation_hex(MILAN_ATTESTATION).await
}

pub async fn verify_genoa_attestation() -> Result<SevVerificationResult, String> {
    verify_attestation_hex(GENOA_ATTESTATION).await
}

pub async fn verify_turin_attestation() -> Result<SevVerificationResult, String> {
    verify_attestation_hex(TURIN_ATTESTATION).await
}
